<!DOCTYPE html>
<html>

<head>
    <title>AI Calculator</title>
    <style>
        body {
            box-sizing: border-box;
            background-color: black;
        }

        canvas {
            border: 1px solid rgba(255, 255, 255, 0.105);
            background-color: rgb(0, 0, 0);
            cursor: cell;
            width: 100%;
            height: 90vh;
        }

        .tools {
            margin: 15px;
            text-align: center;
        }
    </style>

</head>

<body>

    <div class="tools">
        <button onclick="setMode('draw')">‚úèÔ∏è Draw</button>
        <button onclick="setMode('erase')">ü©π Erase</button>
        <button onclick="clearCanvas()">üóëÔ∏è Clear</button>
        <input type="range" id="range_value" class="range_value" name="range_value" min="10" max="50" value="25"
            oninput="this.nextElementSibling.value = this.value">
        <output for="range_value" style="color: white;">25</output>

        <input type="color" id="colorPicker" value="#ffffff">
        <button onclick="submitCanvas()">‚úÖ Calculate</button>
    </div>

    <canvas id="myCanvas"></canvas>

    <script>
        const canvas = document.getElementById("myCanvas");
        const ctx = canvas.getContext("2d");


        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        let drawing = false;
        let mode = "draw"; // "draw" or "erase"

        function setMode(newMode) {
            mode = newMode;
        }

        function startDrawing(e) {
            drawing = true;
            draw(e);
        }

        function stopDrawing() {
            drawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!drawing) return;

            let range_value = document.getElementById("range_value").value;
            let selected_color = document.getElementById("colorPicker").value;

            ctx.lineWidth = (mode === "erase") ? 20 : range_value;
            ctx.lineCap = "round";
            ctx.strokeStyle = (mode === "erase") ? "black" : selected_color;

            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function submitCanvas() {
            const dataURL = canvas.toDataURL("image/png");

            try {
                let response = await fetch("/solve", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image: dataURL })
                });

                if (!response.ok) throw new Error("Server error!");

                let result = await response.json();
                console.log("Backend returned:", result);

                let answer = result.result || "Undefined";

                // Define the area to clear (just enough for result)
                const resultAreaHeight = 50;
                ctx.clearRect(0, canvas.height - resultAreaHeight, canvas.width, resultAreaHeight);

                // Draw the new result
                ctx.font = "50px Arial";
                ctx.fillStyle = "green";
                ctx.fillText("= " + answer, 10, canvas.height - 15);

            } catch (err) {
                console.error(err);
                const resultAreaHeight = 50;
                ctx.clearRect(0, canvas.height - resultAreaHeight, canvas.width, resultAreaHeight);

                ctx.font = "30px Arial";
                ctx.fillStyle = "red";
                ctx.fillText("Error!", 10, canvas.height - 15);
            }
        }




        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mousemove", draw);
    </script>
</body>

</html>